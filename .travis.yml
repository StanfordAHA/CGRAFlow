language: c
dist: trusty

env:
  global:
    - halide_git="https://github.com/jeffsetter/Halide_CoreIR.git"
    - coreir_git="https://github.com/rdaly525/coreir.git"
    - mapper_git="https://github.com/StanfordAHA/CGRAMapper.git"
    - cgra_git="https://github.com/StanfordAHA/CGRAGenerator.git"
    - pnr_git="https://github.com/cdonovick/smt-pnr"
    - smt_git="https://github.com/makaimann/smt-switch" 

    - halide_branch="coreir"
    - coreir_branch="master"
    - mapper_branch="master"
    - cgra_branch="master"
    - pnr_branch="master"
    - smt_branch="master"

    #halide
    - LLVM_VERSION=3.7.1
    - BUILD_SYSTEM=MAKE
    - CXX_=g++-4.9 
    - CC_=gcc-4.9

cache:
  apt: true
  directories:
    # cache smt solvers to speed up build
    ./smt_solvers

compiler:
  - gcc
  
before_install:
  - pip install virtualenv
  - virtualenv -p /usr/bin/python3 CGRAFlowPy3Env
  - source CGRAFlowPy3Env/bin/activate

  #pull all repos
  - git clone -b ${halide_branch} -- ${halide_git}
  - git clone -b ${coreir_branch} -- ${coreir_git}
  - git clone -b ${mapper_branch} -- ${mapper_git}
  - git clone -b ${cgra_branch} -- ${cgra_git}
  - git clone -b ${pnr_branch} -- ${pnr_git}
  - git clone -b ${smt_branch} -- ${smt_git}

  # setup halide env vars
  - source Halide_CoreIR/test/scripts/before_install_travis.sh

  # build coreir
  - cd coreir;
  - export COREIRCONFIG="g++-4.9";
  - export COREIRHOME=$PWD
  - export LD_LIBRARY_PATH=$PWD/bin:$LD_LIBRARY_PATH
  - make install
  - pip install pytest;
  - pip install -e bindings/python;
  - cd ..;

  # I think the script might be lost...here's a quick reset.
  - cd ${TRAVIS_BUILD_DIR};

  - cd CGRAMapper/mapper;
  -   make;
  - cd ../../;

  - date

  # API for SMT solving with different solvers
  - export PYTHONPATH=$PYTHONPATH:$PWD/smt-switch

install:
  -  pwd
  
  # Halide installation (llvm, etc.)
  - ${TRAVIS_BUILD_DIR}/Halide_CoreIR/test/scripts/install_travis.sh

  # pnr
  # run script that installs solvers and adds necessary environment variables
  # if all the solvers are already cached it doesn't need to download
  # if there are any missing solvers, downloads from Makai's AFS
  - . ./smt-pnr/util/get_smt_solvers.sh
  - pip install pygraphviz
  - pip install lxml

script:
  # "set -e" means "die at first error" - seems like a good idea!
  - set -e

  # FIXME Is this still used (RUN_TESTS env var)?
  # I think Jeff added it to prevent Halide from running
  # extensive tests during install?
  - export RUN_TESTS=false

  # Halide files needed are already in the repo

  # This is where Halide actually compiles our app and runs
  # it to build our comparison output parrot "halide_out.png"
  # as well as the DAG "design_top.json" for the mapper.
  #
  - echo "Halide FLOW"
  - cd Halide_CoreIR
      # remake the json and cpu output image for our test app
  -   make -C apps/coreir_examples/pointwise/ clean design_top.json out.png
      # copy over all pertinent files
  -   cp apps/coreir_examples/pointwise/design_top.json ../build
  -   cp apps/images/gray.png                           ../build/input.png
  -   cp apps/coreir_examples/pointwise/out.png         ../build/halide_out.png
  - cd ..

  - ls -la build

  - echo "CONVERT PNG IMAGES TO RAW for visual inspection"
  # Could not get "stream" command to work, so using my (steveri) hacky convert script instead...
  - cd ${TRAVIS_BUILD_DIR}
  - convert=${TRAVIS_BUILD_DIR}/CGRAGenerator/verilator/generator_z_tb/io/myconvert.csh
  - $convert build/input.png      build/input.raw
  - $convert build/halide_out.png build/halide_out.raw

  - echo "VISUALLY CONFIRM THAT OUT = 2*IN"
  - od -t u1 build/input.raw      | head
  - od -t u1 build/halide_out.raw | head

  - ls -la build

  - cat build/design_top.json
#  - xxd build/input.png
#  - xxd build/input.raw
#  - xxd build/halide_out.png
#  - xxd build/halide_out.raw


  # Mapper uses DAG output "design_top.json" from Halide compiler
  # to produce a mapped version "mapped.json" for the PNR folks.  Right?
  #
  - echo "MAPPER"
  - ./CGRAMapper/build/main build/design_top.json build/mapped.json
  - ls -la build
  - cat build/mapped.json



  ##############################################################################

  # CGRA generate
  - echo "CGRA generate (generates CGRA + connection matrix for pnr)" - `date`
  - pushd ${TRAVIS_BUILD_DIR}/CGRAGenerator; ./travis-test.csh; popd

  # pnr
  # IN:  mapped.json      # Output from mapper
  #      cgra_info.txt    # Fully-populated connection matrix from CGRA generator
  #
  # OUT: mapped.xml       # Sparse connection matrix map for CGRA
  #      io.xml           # I/O pin information for CGRA
  #      pnr_bitstream    # bitstream file
  #
  - cd ${TRAVIS_BUILD_DIR}/smt-pnr/src/
  - ./test.py 
    ../../build/mapped.json
    ../../CGRAGenerator/hardware/generator_z/top/cgra_info.txt 
    --xml ../../build/mapped.xml ../../build/io.xml
    --bitstream ../../pnr_bitstream

  # Look at Caleb's bitstream
  - ls -l ../../pnr_bitstream ../../build/mapped.xml
  - cat ../../build/mapped.xml
  - cat ../../pnr_bitstream

  # Decode Caleb's bitstream
  - BS=${TRAVIS_BUILD_DIR}/CGRAGenerator/bitstream
  - export PYTHONPATH=${BS}/decoder/:${PYTHONPATH}
  - ${BS}/decoder/decode.py ../../pnr_bitstream


  # Build Ankita bitstream for comparison

  # bitstream build (ankita perl script)
  # IN:  mapped.xml    (Sparse connection matrix map from PNR)
  # OUT: config.dat    (Bitstream for programming CGRA)
  # 
  # FIXME this is a terrible place for the perl script to live
  # FIXME don't worry soon it will be replaced by Caleb's script
  #
  - echo "Build bitstream for programming CGRA" - `date`
  - GENBS=${TRAVIS_BUILD_DIR}/CGRAGenerator/bitstream/example3/
  - ls -l ${GENBS}/gen_bitstream.pl
       ${TRAVIS_BUILD_DIR}/build/mapped.xml
  - perl ${GENBS}/gen_bitstream.pl
       ${TRAVIS_BUILD_DIR}/build/mapped.xml
       ${TRAVIS_BUILD_DIR}/build/config
       || exit -1

  # Decode Ankita's bitstream
  - BS=${TRAVIS_BUILD_DIR}/CGRAGenerator/bitstream
  - export PYTHONPATH=${BS}/decoder/:${PYTHONPATH}
  - ${BS}/decoder/decode.py ${TRAVIS_BUILD_DIR}/build/config.dat



  ##############################################################################
  # Little temporary hack to get around instabilities above when/if needed.
  # - EXAMPLE3=${TRAVIS_BUILD_DIR}/CGRAGenerator/bitstream/example3;
  # - cp ${EXAMPLE3}/PNRguys_config.dat ${TRAVIS_BUILD_DIR}/build/config.dat;
  # - cp ${EXAMPLE3}/PNRguys_io.xml     ${TRAVIS_BUILD_DIR}/build/io.xml;
  ##############################################################################

  # cgra program and run
  # IN:  config.dat    (Bitstream for programming CGRA)
  #      io.xml        (I/O pin information for CGRA)
  #      input.png     (Input image)
  # OUT: CGRA_out.raw  (Output image)
  #
  - echo "CGRA program and run (uses output of pnr)" - `date`
  - cd ${TRAVIS_BUILD_DIR}/CGRAGenerator/verilator/generator_z_tb
  - ./run.csh top_tb.cpp
        -config ${TRAVIS_BUILD_DIR}/build/config.dat
        -io     ${TRAVIS_BUILD_DIR}/build/io.xml
        -input  ${TRAVIS_BUILD_DIR}/build/input.png
        -output ${TRAVIS_BUILD_DIR}/build/CGRA_out.raw
        -nclocks 5M


  # check to see that output is correct.

  - echo "BYTE-BY-BYTE COMPARE OF CGRA VS. HALIDE OUTPUT IMAGES"
  - ls -l ${TRAVIS_BUILD_DIR}/build/*.raw
  - cmp   ${TRAVIS_BUILD_DIR}/build/halide_out.raw
          ${TRAVIS_BUILD_DIR}/build/CGRA_out.raw

  - echo "VISUAL COMPARE OF CGRA VS. HALIDE OUTPUT BYTES (should be null)"
  - od -t u1 -w1 -v -A none ${TRAVIS_BUILD_DIR}/build/halide_out.raw > /tmp/halide_out.od
  - od -t u1 -w1 -v -A none ${TRAVIS_BUILD_DIR}/build/CGRA_out.raw   > /tmp/CGRA_out.od
  - diff /tmp/halide_out.od
         /tmp/CGRA_out.od
         |& head -500



addons:
  apt:
    sources:
      - ubuntu-toolchain-r-test
    packages:
      # rigel
      - verilator
      - luajit

      # coreir
      - build-essential
      - clang

      # halide
      - g++-4.9
      - libedit-dev
      - libpng-dev

      # CGRAGEN
      - csh

      # pnr
      - libgmp3-dev
      - git
      - cmake
      - zlib1g
      - zlib1g-dev
      - graphviz-dev
      - python3
      - swig2.0
      - libcln-dev

      # convert png to raw
      - imagemagick
